# Agent 7 - Refund Filing Worker Hardening

**Date:** January 4, 2026  
**Author:** Automated Implementation  
**Review Required:** Backend Team

---

## Executive Summary

Agent 7 (Refund Filing Agent) has been hardened with 9 critical safety mechanisms to prevent detection, bans, fraud accusations, and chain bans when interacting with Amazon's systems. This document details all implemented safeguards.

---

## 1. Velocity Limit with Jitter

**File:** `src/workers/refundFilingWorker.ts`

**Problem:** Fixed-interval submissions (e.g., exactly every 60 seconds) create robotic patterns that Amazon's bot detection algorithms can identify.

**Solution:** Randomized delays between 180-420 seconds (3-7 minutes) between each claim submission.

```typescript
function getJitterMs(minSeconds: number = 180, maxSeconds: number = 420): number {
  const jitterSeconds = Math.floor(Math.random() * (maxSeconds - minSeconds + 1)) + minSeconds;
  return jitterSeconds * 1000;
}
```

**Behavior:**
- Claim 1 submitted
- Wait 247 seconds (random)
- Claim 2 submitted
- Wait 389 seconds (random)
- Pattern looks human

---

## 2. Flood Protection Throttle

**File:** `src/workers/refundFilingWorker.ts`

**Problem:** Submitting too many claims in a short period triggers API rate limits and DDoS-like detection.

**Solution:** Conservative limits on claims per run and per hour.

```typescript
private static readonly THROTTLE_CONFIG = {
  MAX_PER_RUN: 3,        // Only process 3 claims per 5-minute run
  MAX_PER_HOUR: 12,      // Max 12 claims per hour (soft limit)
  MAX_PER_DAY: 100,      // Daily ceiling (for reference)
};
```

**Behavior:**
- Before processing, check `dispute_submissions` for filings in last hour
- If hourly quota reached, skip run entirely
- Query limited to `maxThisRun` to only fetch what can be processed

---

## 3. Duplicate Prevention

**File:** `src/workers/refundFilingWorker.ts`

**Problem:** Filing the same claim twice while the first is still active triggers "Abuse of Seller Support" flags. 3 strikes = API ban.

**Solution:** Check for active claims before filing.

```typescript
private async hasActiveClaimForOrder(orderId: string, sellerId: string): Promise<boolean>
```

**Behavior:**
1. Before filing Order #123, query `dispute_cases`
2. Check if any active case (not closed/approved/rejected) exists for same order_id
3. If found, skip and set status to `duplicate_blocked`

**Status Added:** `filing_status = 'duplicate_blocked'`

---

## 4. Double-Dip Prevention (Reimbursement Check)

**File:** `src/workers/refundFilingWorker.ts`

**Problem:** Amazon sometimes auto-reimburses without seller noticing. Filing a claim for an already-reimbursed item is considered theft/fraud.

**Solution:** Check `financial_events` table for prior reimbursements.

```typescript
private async wasAlreadyReimbursed(
  orderId: string,
  sku: string | undefined,
  asin: string | undefined,
  sellerId: string
): Promise<boolean>
```

**Behavior:**
1. Query `financial_events` for `event_type = 'reimbursement'`
2. Match by `amazon_order_id` (or `amazon_sku` fallback)
3. Check last 6 months
4. If found, skip and set status to `already_reimbursed`

**Status Added:** `filing_status = 'already_reimbursed'`

---

## 5. Metadata Scrubbing (Anti-Fingerprint)

**File:** `src/utils/pdfMetadataScrubber.ts`

**Problem:** PDFs generated by scripts have metadata like `Creator: Puppeteer`, `Producer: Chrome` which signals automation.

**Solution:** Utility to provide realistic scanner/business software metadata.

```typescript
const METADATA_PROFILES = {
  scanner: {
    creators: ['Canon MG3600 series', 'HP OfficeJet Pro 8035', ...],
    producers: ['Canon IJ Scan Utility', 'HP Scan', ...],
  },
  office: {
    creators: ['Microsoft Excel', 'Adobe Acrobat', ...],
    producers: ['Microsoft: Print To PDF', 'Adobe PDF Library', ...],
  },
  accounting: {
    creators: ['QuickBooks Online', 'Xero', ...],
    producers: ['QuickBooks PDF Printer', 'Adobe PDF Library 15.0', ...],
  },
};
```

**Functions:**
- `getCleanMetadata(options)` - Returns randomized clean metadata
- `hasScriptMetadata(metadata)` - Detects suspicious automation markers
- `logMetadataScrub()` - Audit logging for compliance

---

## 6. High-Value Claim Approval ($500 Threshold)

**File:** `src/workers/refundFilingWorker.ts`

**Problem:** LLMs can hallucinate when parsing documents (e.g., reading "10 units" as "100 units"). Auto-submitting high-value claims based on hallucinated data causes fraud accusations.

**Solution:** Claims over $500 require manual approval.

```typescript
private static readonly HIGH_VALUE_THRESHOLD = 500; // USD

if (claimAmount > RefundFilingWorker.HIGH_VALUE_THRESHOLD) {
  // Mark for manual approval instead of auto-filing
  filing_status = 'pending_approval';
}
```

**Status Added:** `filing_status = 'pending_approval'`

---

## 7. Professional Text Logging

**File:** All modified files

**Problem:** Emoji characters in log messages can cause issues in some log aggregators and are not appropriate for enterprise/institutional environments.

**Solution:** All emoji prefixes removed, replaced with text labels.

| Before | After |
|--------|-------|
| `üìù [REFUND FILING]` | `[REFUND FILING]` |
| `‚ùå [ERROR]` | `[ERROR] [REFUND FILING]` |
| `‚ö†Ô∏è [WARN]` | `[WARN] [REFUND FILING]` |
| `üîÑ [RETRY]` | `[RETRY] [REFUND FILING]` |

---

## 8. Kill Switch (Credit Note Quarantine)

**File:** `src/workers/refundFilingWorker.ts`

**Problem:** If a credit note (you owe money) is mistakenly submitted as an invoice (proof of ownership), Amazon immediately bans the account for fraud. No appeals.

**Solution:** Detect and quarantine documents with dangerous keywords in filenames.

```typescript
private static readonly DANGEROUS_DOCUMENT_PATTERNS = [
  'credit', 'credit_note', 'credit-note', 'creditnote',
  'return', 'returned',
  'refund', 'refunded',
  'rma',
  'reversal', 'chargeback', 'debit_note', 'adjustment',
];
```

**Behavior:**
1. Before filing, check all evidence document filenames
2. If any match dangerous patterns, quarantine the case
3. Set status to `quarantined_dangerous_doc`
4. Case requires human review before any submission

**Status Added:** `filing_status = 'quarantined_dangerous_doc'`

---

## 9. IP Contamination Prevention

**Files:**
- `migrations/039_seller_proxy_assignments.sql`
- `src/services/proxyAssignmentService.ts`
- `src/services/sellerHttpClient.ts`
- `src/services/refundFilingService.ts`

**Problem:** Multiple seller accounts accessed from the same IP address causes Amazon to link them. If one account is banned, all linked accounts get chain-banned.

**Solution:** Dedicated residential proxy per seller using sticky sessions.

### Database Schema
```sql
CREATE TABLE seller_proxy_assignments (
  id UUID PRIMARY KEY,
  seller_id TEXT NOT NULL UNIQUE,
  proxy_session_id TEXT NOT NULL,
  proxy_provider TEXT DEFAULT 'brightdata',
  proxy_region TEXT DEFAULT 'us',
  last_known_ip TEXT,
  status TEXT DEFAULT 'active'
);
```

### Proxy Assignment Service
- Maps each seller to a unique sticky session ID
- Supports Bright Data, Oxylabs, SmartProxy
- Session ID is deterministic (hash of seller_id) for consistency across restarts

### Seller HTTP Client
- Drop-in wrapper for axios
- Automatically routes requests through seller's assigned proxy
- Logs proxy usage for audit

### Configuration
```env
ENABLE_PROXY_ROUTING=true
PROXY_PROVIDER=brightdata
PROXY_HOST=brd.superproxy.io
PROXY_PORT=22225
PROXY_USERNAME=your_username
PROXY_PASSWORD=your_password
PROXY_ZONE=residential
PROXY_COUNTRY=us
```

---

## Filing Status Summary

| Status | Meaning |
|--------|---------|
| `pending` | Ready for auto-filing |
| `pending_approval` | High-value, needs human approval |
| `filed` | Successfully submitted to Amazon |
| `duplicate_blocked` | Active claim exists for same order |
| `already_reimbursed` | Amazon already paid for this item |
| `quarantined_dangerous_doc` | Contains credit notes/returns |
| `failed` | Filing failed after retries |

---

## Environment Variables

| Variable | Default | Description |
|----------|---------|-------------|
| `ENABLE_PROXY_ROUTING` | `false` | Enable seller-specific proxies |
| `PROXY_PROVIDER` | `brightdata` | Proxy provider (brightdata/oxylabs/smartproxy) |
| `PROXY_HOST` | `brd.superproxy.io` | Proxy server host |
| `PROXY_PORT` | `22225` | Proxy server port |
| `PROXY_USERNAME` | - | Proxy credentials |
| `PROXY_PASSWORD` | - | Proxy credentials |
| `PROXY_ZONE` | `residential` | Proxy zone type |
| `PROXY_COUNTRY` | `us` | Target country for IPs |

---

## Testing Recommendations

1. **Jitter Verification:** Run worker and verify delays are randomized (check logs)
2. **Throttle Test:** Create 15+ pending claims, verify only 12 processed per hour
3. **Duplicate Test:** Create two claims for same order_id, verify second is blocked
4. **Reimbursement Test:** Add mock reimbursement to `financial_events`, verify claim skipped
5. **Kill Switch Test:** Upload document with "credit_note" in filename, verify quarantine
6. **Proxy Test:** Enable proxy routing, verify different sellers use different IPs

---

## Commit History

1. `Agent 7: Add flood protection throttle (3 per run, 12 per hour max)`
2. `Agent 7: Add duplicate prevention - check for active claims before filing`
3. `Agent 7: Add double-dip prevention - check financial_events for prior reimbursements`
4. `Agent 7: Add PDF metadata scrubbing utility for anti-detection`
5. `Agent 7: Add high-value claim approval threshold ($500)`
6. `Remove all emojis from Agent 7 code - professional text-only logging`
7. `Agent 7: Add KILL SWITCH - quarantine credit notes, returns, refunds`
8. `Agent 7: Add IP contamination prevention - proxy assignment service`

---

## Next Steps (Recommended)

1. **Run database migration** for `seller_proxy_assignments` table
2. **Configure proxy provider** credentials in environment
3. **Test in staging** with mock claims
4. **Frontend UI** for managing quarantined/pending_approval claims
5. **Monitoring dashboard** for proxy IP audit trail
